{% extends "base.html" %}

{% block title %}Accueil - Climbing App{% endblock %}

{% block content %}
<div class="hero-section text-center py-5 mb-5">
    <div class="container">
        <h1 class="display-4 fw-bold text-primary mb-4">
            <i class="fas fa-mountain"></i> Climbing Competition
        </h1>
        <p class="lead mb-4">
            Plateforme de gestion des compétitions d'escalade avec validation tactile
        </p>
        
        <!-- Statut de la compétition -->
        <div class="row justify-content-center mb-4">
            <div class="col-md-8">
                <div class="card border-info">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-trophy text-warning"></i>
                            Compétition en cours
                        </h5>
                        <div id="competition-status">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row g-4">
        <!-- Actions principales -->
        <div class="col-lg-8">
            <div class="row g-4">
                <!-- Connexion Grimpeur -->
                <div class="col-md-6">
                    <div class="card h-100 action-card" onclick="showLoginModal('grimpeur')">
                        <div class="card-body text-center">
                            <div class="icon-circle bg-primary mb-3">
                                <i class="fas fa-user-climbing text-white fs-1"></i>
                            </div>
                            <h5 class="card-title">Espace Grimpeur</h5>
                            <p class="card-text text-muted">
                                Connectez-vous avec votre code pour valider vos voies
                            </p>
                            <div class="btn btn-primary">
                                <i class="fas fa-sign-in-alt"></i>
                                Se connecter
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Administration -->
                <div class="col-md-6">
                    <div class="card h-100 action-card" onclick="showLoginModal('admin')">
                        <div class="card-body text-center">
                            <div class="icon-circle bg-success mb-3">
                                <i class="fas fa-user-shield text-white fs-1"></i>
                            </div>
                            <h5 class="card-title">Administration</h5>
                            <p class="card-text text-muted">
                                Gestion des compétitions, voies et utilisateurs
                            </p>
                            <div class="btn btn-success">
                                <i class="fas fa-cogs"></i>
                                Administrer
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inscription publique -->
                <div class="col-md-6">
                    <div class="card h-100 action-card" onclick="location.href='/public/inscription'">
                        <div class="card-body text-center">
                            <div class="icon-circle bg-info mb-3">
                                <i class="fas fa-user-plus text-white fs-1"></i>
                            </div>
                            <h5 class="card-title">Inscription</h5>
                            <p class="card-text text-muted">
                                Inscrivez-vous à la compétition
                            </p>
                            <div class="btn btn-info">
                                <i class="fas fa-pen"></i>
                                S'inscrire
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classement public -->
                <div class="col-md-6">
                    <div class="card h-100 action-card" onclick="location.href='/public/classement'">
                        <div class="card-body text-center">
                            <div class="icon-circle bg-warning mb-3">
                                <i class="fas fa-medal text-white fs-1"></i>
                            </div>
                            <h5 class="card-title">Classements</h5>
                            <p class="card-text text-muted">
                                Consultez les résultats en temps réel
                            </p>
                            <div class="btn btn-warning">
                                <i class="fas fa-trophy"></i>
                                Voir les résultats
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i>
                        Informations
                    </h6>
                </div>
                <div class="card-body">
                    <div id="competition-info">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar"></i>
                        Statistiques
                    </h6>
                </div>
                <div class="card-body">
                    <div id="stats-container">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de connexion -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sign-in-alt"></i>
                    Connexion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Code de connexion</label>
                        <input type="text" 
                               class="form-control form-control-lg text-center" 
                               id="codeInput" 
                               placeholder="000000"
                               maxlength="6"
                               pattern="[0-9]{6}"
                               style="letter-spacing: 0.5rem; font-family: monospace;">
                        <div class="form-text">
                            Saisissez votre code à 6 chiffres
                        </div>
                    </div>
                    <input type="hidden" id="userType" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <button type="button" class="btn btn-primary" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i>
                    Se connecter
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables globales
let currentUserType = '';

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadCompetitionStatus();
    loadStats();
    
    // Auto-focus sur le code quand modal s'ouvre
    document.getElementById('loginModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('codeInput').focus();
    });
    
    // Validation en temps réel du code
    document.getElementById('codeInput').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 6) value = value.slice(0, 6);
        e.target.value = value;
        
        // Auto-login si 6 chiffres
        if (value.length === 6) {
            setTimeout(() => login(), 300);
        }
    });
    
    // Enter pour se connecter
    document.getElementById('codeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            login();
        }
    });
});

// Affichage du modal de connexion
function showLoginModal(type) {
    currentUserType = type;
    document.getElementById('userType').value = type;
    document.getElementById('codeInput').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('loginModal'));
    modal.show();
}

// Connexion
function login() {
    const code = document.getElementById('codeInput').value.trim();
    const userType = document.getElementById('userType').value;
    
    if (code.length !== 6) {
        showAlert('Veuillez saisir un code à 6 chiffres', 'warning');
        return;
    }
    
    // Disable form
    const form = document.getElementById('loginForm');
    const btn = form.closest('.modal-content').querySelector('.btn-primary');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Connexion...';
    
    fetch('/api/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            code: code,
            type: userType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirection selon le type d'utilisateur
            if (data.user.role === 'admin' || data.user.role === 'ouvreur') {
                window.location.href = '/admin/dashboard';
            } else {
                window.location.href = '/grimpeur/dashboard';
            }
        } else {
            showAlert(data.message || 'Code incorrect', 'danger');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showAlert('Erreur de connexion', 'danger');
    })
    .finally(() => {
        // Re-enable form
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Se connecter';
    });
}

// Chargement du statut de la compétition
function loadCompetitionStatus() {
    fetch('/api/competition/current')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('competition-status');
            if (data.competition) {
                container.innerHTML = `
                    <h6 class="mb-2">${data.competition.nom}</h6>
                    <p class="mb-2 text-muted">${data.competition.description || ''}</p>
                    <div class="row text-center">
                        <div class="col">
                            <small class="text-muted">Début</small><br>
                            <strong>${formatDate(data.competition.date_debut)}</strong>
                        </div>
                        <div class="col">
                            <small class="text-muted">Fin</small><br>
                            <strong>${formatDate(data.competition.date_fin)}</strong>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle"></i>
                        Aucune compétition en cours
                    </p>
                `;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('competition-status').innerHTML = `
                <p class="text-danger mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erreur de chargement
                </p>
            `;
        });
}

// Chargement des statistiques
function loadStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('stats-container');
            container.innerHTML = `
                <div class="row text-center g-3">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="fs-4 fw-bold text-primary">${data.total_grimpeurs || 0}</div>
                            <small class="text-muted">Grimpeurs</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="fs-4 fw-bold text-success">${data.total_voies || 0}</div>
                            <small class="text-muted">Voies</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="fs-4 fw-bold text-warning">${data.total_validations || 0}</div>
                            <small class="text-muted">Validations</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="fs-4 fw-bold text-info">${data.categories_count || 0}</div>
                            <small class="text-muted">Catégories</small>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('stats-container').innerHTML = `
                <p class="text-danger text-center mb-0">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    Erreur de chargement
                </p>
            `;
        });
}

// Utilitaires
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove après 5 secondes
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

<style>
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0 0 2rem 2rem;
}

.action-card {
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.icon-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.stat-item {
    padding: 1rem;
    border-radius: 0.5rem;
    background: rgba(108, 117, 125, 0.1);
}

/* Style pour le code input */
#codeInput {
    font-size: 1.5rem !important;
}

/* Animation des cartes */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeInUp 0.6s ease-out;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .hero-section .display-4 {
        font-size: 2rem;
    }
    
    .icon-circle {
        width: 60px;
        height: 60px;
    }
    
    .icon-circle i {
        font-size: 1.5rem !important;
    }
}
</style>
{% endblock %}
