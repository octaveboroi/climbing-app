<!-- templates/grimpeur/voies.html - Liste des voies -->
{% extends "base.html" %}
{% block title %}Voies - Grimpeur{% endblock %}
{% block header_title %}Voies disponibles{% endblock %}
{% block content %}
<div class="p-4">
    <!-- Filtre par compétition -->
    <div class="mb-6 bg-white p-4 rounded-lg shadow">
        <label class="form-label">Compétition</label>
        <select id="competition-select" class="form-input" onchange="loadVoies()">
            <option value="">Sélectionnez une compétition</option>
        </select>
    </div>
    
    <!-- Liste des voies -->
    <div id="voies-container" class="grid gap-4">
        <div class="text-center py-8 text-gray-500">
            Sélectionnez une compétition pour voir les voies
        </div>
    </div>
</div>

<script>
// Charger les compétitions au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadCompetitions();
    
    // Restaurer la compétition sélectionnée si elle existe
    const savedCompetitionId = sessionStorage.getItem('currentCompetitionId');
    if (savedCompetitionId) {
        setTimeout(() => {
            document.getElementById('competition-select').value = savedCompetitionId;
            loadVoies();
        }, 500);
    }
});

function loadCompetitions() {
    fetch('/api/grimpeur/competitions')
        .then(response => response.json())
        .then(competitions => {
            const select = document.getElementById('competition-select');
            select.innerHTML = '<option value="">Sélectionnez une compétition</option>';
            
            competitions.forEach(comp => {
                const option = document.createElement('option');
                option.value = comp.id;
                option.textContent = `${comp.nom} (${comp.date_debut})`;
                select.appendChild(option);
            });
        });
}

function loadVoies() {
    const competitionId = document.getElementById('competition-select').value;
    if (!competitionId) {
        document.getElementById('voies-container').innerHTML = 
            '<div class="text-center py-8 text-gray-500">Sélectionnez une compétition pour voir les voies</div>';
        return;
    }
    
    sessionStorage.setItem('currentCompetitionId', competitionId);
    
    const container = document.getElementById('voies-container');
    container.innerHTML = '<div class="loading h-40 col-span-full"></div>';
    
    fetch(`/api/voies/list?competition_id=${competitionId}`)
        .then(response => response.json())
        .then(voies => {
            if (voies.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Aucune voie disponible</div>';
                return;
            }
            
            container.innerHTML = voies.map(voie => `
                <div class="voie-card bg-white rounded-lg shadow overflow-hidden fade-in">
                    <div class="relative">
                        <img src="${voie.image_path}" alt="${voie.nom}" class="w-full h-48 object-cover">
                        <div class="absolute top-2 right-2">
                            ${voie.validated ? 
                                '<span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs">✓ Validée</span>' :
                                '<span class="bg-gray-500 text-white px-2 py-1 rounded-full text-xs">Non tentée</span>'
                            }
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-2">${voie.nom}</h3>
                        <p class="text-gray-600 mb-4">Niveau: ${voie.level_name}</p>
                        <button onclick="openVoie(${voie.id})" 
                                class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            ${voie.validated ? 'Voir' : 'Tenter'}
                        </button>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Erreur:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Erreur de chargement</div>';
        });
}

function openVoie(voieId) {
    window.location.href = `/grimpeur/voie/${voieId}`;
}
</script>
{% endblock %}
