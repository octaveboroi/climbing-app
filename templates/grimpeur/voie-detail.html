<!-- templates/grimpeur/voie-detail.html - Détail d'une voie -->
{% extends "base.html" %}
{% block title %}{{ voie.nom }} - Voie{% endblock %}
{% block header_title %}{{ voie.nom }}{% endblock %}
{% block content %}
<div class="h-screen flex flex-col">
    <!-- Info voie -->
    <div class="bg-blue-600 text-white p-4 flex-shrink-0">
        <h2 class="text-xl font-bold" id="voie-title">{{ voie.nom }}</h2>
        <p class="opacity-90" id="voie-level">Niveau: {{ voie.level.nom if voie.level }}</p>
        <div id="validation-status" class="mt-2">
            <!-- Status chargé dynamiquement -->
        </div>
    </div>
    
    <!-- Container image avec zoom/pan -->
    <div class="flex-1 relative overflow-hidden bg-gray-900" id="image-container">
        <img id="voie-image" 
             src="{{ voie.image_path }}" 
             alt="{{ voie.nom }}"
             class="voie-image w-full h-full object-contain"
             style="transform-origin: center center;">
        <!-- Cercles ajoutés dynamiquement -->
    </div>
    
    <!-- Contrôles de zoom -->
    <div class="zoom-controls no-print">
        <button onclick="zoomIn()" class="zoom-btn bg-blue-600 text-white hover:bg-blue-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
        </button>
        <button onclick="zoomOut()" class="zoom-btn bg-blue-600 text-white hover:bg-blue-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
            </svg>
        </button>
        <button onclick="resetView()" class="zoom-btn bg-gray-600 text-white hover:bg-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>
    
    <!-- Boutons d'action -->
    <div class="floating-buttons no-print">
        <button id="validate-btn" 
                onclick="validateSelection()" 
                class="bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-400" 
                disabled>
            Valider
        </button>
        <button onclick="goBack()" 
                class="bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors">
            Retour
        </button>
    </div>
</div>

<script src="{{ url_for('static', filename='js/voie-detail.js') }}"></script>
<script>
// Variables globales
let voieId = {{ voie.id }};
let competitionId = sessionStorage.getItem('currentCompetitionId');
let selectedCircle = null;
let scale = 1;
let translateX = 0;
let translateY = 0;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadVoieData();
    initImageControls();
});

function loadVoieData() {
    fetch(`/api/voie/${voieId}`)
        .then(response => response.json())
        .then(data => {
            // Charger les cercles
            const container = document.getElementById('image-container');
            
            // Supprimer les anciens cercles
            container.querySelectorAll('.circle').forEach(el => el.remove());
            
            // Ajouter les nouveaux cercles
            data.circles.forEach(circle => {
                const circleEl = createCircle(circle);
                container.appendChild(circleEl);
            });
            
            // Vérifier le statut de validation
            checkValidationStatus();
        });
}

function createCircle(circleData) {
    const circle = document.createElement('div');
    circle.className = 'circle';
    circle.style.position = 'absolute';
    circle.style.left = `${circleData.x}%`;
    circle.style.top = `${circleData.y}%`;
    circle.style.width = `${circleData.radius}%`;
    circle.style.height = `${circleData.radius}%`;
    circle.style.border = '2px solid red';
    circle.style.borderRadius = '50%';
    circle.style.background = 'rgba(255, 0, 0, 0.1)';
    circle.style.cursor = 'pointer';
    circle.style.display = 'flex';
    circle.style.alignItems = 'center';
    circle.style.justifyContent = 'center';
    circle.style.fontSize = '14px';
    circle.style.fontWeight = 'bold';
    circle.style.color = 'red';
    circle.style.userSelect = 'none';
    
    // Ne pas afficher l'ordre pour les grimpeurs
    // circle.textContent = circleData.ordre;
    
    circle.dataset.id = circleData.id;
    circle.dataset.order = circleData.ordre;
    
    circle.addEventListener('click', function(e) {
        e.stopPropagation();
        selectCircle(circle);
    });
    
    return circle;
}

function selectCircle(circle) {
    // Désélectionner les autres
    document.querySelectorAll('.circle').forEach(c => {
        c.style.borderColor = 'red';
        c.style.background = 'rgba(255, 0, 0, 0.1)';
        c.style.color = 'red';
    });
    
    // Sélectionner le cercle cliqué
    circle.style.borderColor = 'blue';
    circle.style.background = 'rgba(0, 0, 255, 0.2)';
    circle.style.color = 'blue';
    circle.textContent = circle.dataset.order; // Afficher l'ordre quand sélectionné
    
    selectedCircle = circle;
    document.getElementById('validate-btn').disabled = false;
}

function validateSelection() {
    if (!selectedCircle || !competitionId) {
        alert('Erreur: cercle ou compétition non sélectionnée');
        return;
    }
    
    const confirmMsg = `Confirmer la validation jusqu'au point ${selectedCircle.dataset.order} ?`;
    if (!confirm(confirmMsg)) return;
    
    document.getElementById('validate-btn').disabled = true;
    document.getElementById('validate-btn').textContent = 'Validation...';
    
    fetch('/api/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            circle_id: parseInt(selectedCircle.dataset.id),
            voie_id: voieId,
            competition_id: parseInt(competitionId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Validation enregistrée avec succès !');
            goBack();
        } else {
            alert('Erreur: ' + (data.message || 'Validation échouée'));
            document.getElementById('validate-btn').disabled = false;
            document.getElementById('validate-btn').textContent = 'Valider';
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur de connexion');
        document.getElementById('validate-btn').disabled = false;
        document.getElementById('validate-btn').textContent = 'Valider';
    });
}

function checkValidationStatus() {
    if (!competitionId) return;
    
    fetch(`/api/grimpeur/validation-status?voie_id=${voieId}&competition_id=${competitionId}`)
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('validation-status');
            if (data.validated) {
                statusEl.innerHTML = `
                    <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm">
                        ✓ Validée (Point ${data.circle_order})
                    </span>
                `;
            } else {
                statusEl.innerHTML = `
                    <span class="bg-gray-500 text-white px-3 py-1 rounded-full text-sm">
                        Non tentée
                    </span>
                `;
            }
        });
}

function goBack() {
    window.location.href = '/grimpeur/voies';
}

// Contrôles d'image
function initImageControls() {
    const image = document.getElementById('voie-image');
    const container = document.getElementById('image-container');
    
    let isPanning = false;
    let startX, startY;
    
    // Gestion tactile
    container.addEventListener('touchstart', handleTouchStart, { passive: false });
    container.addEventListener('touchmove', handleTouchMove, { passive: false });
    container.addEventListener('touchend', handleTouchEnd);
    
    // Gestion souris
    container.addEventListener('mousedown', handleMouseDown);
    container.addEventListener('mousemove', handleMouseMove);
    container.addEventListener('mouseup', handleMouseUp);
    
    function handleTouchStart(e) {
        if (e.touches.length === 1 && !e.target.classList.contains('circle')) {
            isPanning = true;
            startX = e.touches[0].clientX - translateX;
            startY = e.touches[0].clientY - translateY;
        }
    }
    
    function handleTouchMove(e) {
        if (isPanning && e.touches.length === 1) {
            e.preventDefault();
            translateX = e.touches[0].clientX - startX;
            translateY = e.touches[0].clientY - startY;
            updateImageTransform();
        }
    }
    
    function handleTouchEnd() {
        isPanning = false;
    }
    
    function handleMouseDown(e) {
        if (e.target.classList.contains('circle')) return;
        isPanning = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
    }
    
    function handleMouseMove(e) {
        if (isPanning) {
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateImageTransform();
        }
    }
    
    function handleMouseUp() {
        isPanning = false;
    }
}

function updateImageTransform() {
    const image = document.getElementById('voie-image');
    image.style.transform = `scale(${scale}) translate(${translateX/scale}px, ${translateY/scale}px)`;
}

function zoomIn() {
    scale = Math.min(scale * 1.3, 4);
    updateImageTransform();
}

function zoomOut() {
    scale = Math.max(scale / 1.3, 0.3);
    updateImageTransform();
}

function resetView() {
    scale = 1;
    translateX = 0;
    translateY = 0;
    updateImageTransform();
}
</script>
{% endblock %}
